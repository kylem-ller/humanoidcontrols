% Physics Setup
L1 = 5 * 0.0254; % m
Lc1 = 0.5 * L1;
L2 = 3.5 / 5 * L1;
g = 9.81;
freq = 100/1000; % ms
mw = 0.01;
m1 = 0.2;

% Equations Of Motion
x0 = sym('x',[4 1]); % m2*L2*(L2-L1*cos(x0(3)))
M = [mw+m1 -m1*Lc1*cos(x0(3)); -m1*Lc1*cos(x0(3)) m1*Lc1^2];
V = [m1*Lc1*x0(4)*sin(x0(3)); 0];
G = [0; -m1*g*Lc1*sin(x0(3))];
% M = [m1*Lc1^2+m2*(L1^2+L2^2-2*L1*L2*cos(x0(3))) 0; 0 m2*L2^2];
% V = [m2*L1*L2*x0(4)*(2*x0(2)+x0(4))*sin(x0(3)); -m2*L1*L2*x0(2)^2*sin(x0(3))];
% G = [-m1*g*Lc1*sin(x0(1))+m2*g*(-L1*sin(x0(1))+L2*sin(x0(1)+x0(3))); m2*g*L2*sin(x0(1)+x0(3))];

f1(x0) = M^(-1)*(-V-G);
f2(x0) = M^(-1)*([1 0]');
f2v = f2(x0(1),x0(2),x0(3),x0(4));

d1 = diff(f1,x0(1));
d1 = d1(x0(1),x0(2),x0(3),x0(4));
d2 = diff(f1,x0(1));
d2 = d2(x0(1),x0(2),x0(3),x0(4));
d3 = diff(f1,x0(1));
d3 = d3(x0(1),x0(2),x0(3),x0(4));
d4 = diff(f1,x0(1));
d4 = d4(x0(1),x0(2),x0(3),x0(4));

% Control System
A(x0) = freq * [0     1     0     0; ...
                d1(1) d2(1) d3(1) d4(1); ...
                0     0     0     1; ... 
                d1(2) d2(2) d3(2) d4(2)] + eye(4);
B(x0) = freq * [0 f2v(1) 0 f2v(2)]';

R = 1/(0.1^2);
Q = [1/(0.1)^2 0     0          0;...
         0          1/(0.1)^2 0          0;...
         0          0     1/(pi/4)^2 0;...%1/(pi/2)^2 0;...
         0          0     0          1/(pi/4)^2];

A_now = double(A(0,0,0,0));
B_now = double(B(0,0,0,0));

[K,~,~] = dlqr(A_now, B_now, Q, R);
K = K